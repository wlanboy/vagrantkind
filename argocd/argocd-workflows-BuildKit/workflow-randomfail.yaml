apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: randomfail-buildkit
  namespace: argo-workflows
spec:
  entrypoint: main
  serviceAccountName: workflow-sa
  arguments:
    parameters:
      - name: image-tag
        value: latest
      - name: git-ref
        value: refs/heads/main
      - name: dockerfile
        value: Dockerfile
      - name: push
        value: "true"

  templates:
    - name: main
      steps:
        - - name: build
            template: buildkit-build
        - - name: update-chart
            template: git-update

    - name: buildkit-build
      script:
        image: moby/buildkit:rootless
        command: [sh]
        source: |
          TAG={{workflow.parameters.image-tag}}
          TOKEN=$(cat /var/run/secrets/github/token)
          buildctl --addr tcp://buildkitd.argo-workflows.svc.cluster.local:1234 build \
            --frontend=dockerfile.v0 \
            --opt context=https://wlanboy:${TOKEN}@github.com/wlanboy/randomfail.git#{{workflow.parameters.git-ref}} \
            --opt filename={{workflow.parameters.dockerfile}} \
            --opt build-arg:BUILDKIT_INLINE_CACHE=1 \
            --output "type=image,name=docker.io/wlanboy/randomfail:${TAG},name=docker.io/wlanboy/randomfail:latest,push={{workflow.parameters.push}}" \
            --export-cache type=registry,ref=local-registry.argo-workflows.svc.cluster.local:5000/cache/randomfail,mode=max,registry.insecure=true \
            --import-cache type=registry,ref=local-registry.argo-workflows.svc.cluster.local:5000/cache/randomfail,registry.insecure=true
        env:
          - name: DOCKER_CONFIG
            value: /home/user/.docker
        volumeMounts:
          - name: docker-config
            mountPath: /home/user/.docker
          - name: github-token
            mountPath: /var/run/secrets/github
      volumes:
        - name: docker-config
          secret:
            secretName: regcred
            items:
              - key: .dockerconfigjson
                path: config.json
        - name: github-token
          secret:
            secretName: github-token
            items:
              - key: token
                path: token

    - name: git-update
      script:
        image: docker.io/alpine/git:latest
        command: [sh]
        source: |
          TOKEN=$(cat /var/run/secrets/github/token)
          TAG="{{workflow.parameters.image-tag}}"

          git clone "https://wlanboy:${TOKEN}@github.com/wlanboy/randomfail.git" /tmp/repo
          cd /tmp/repo/randomfail-chart

          sed -i "s|^  tag:.*|  tag: ${TAG}|" values.yaml

          git config user.email "argo-workflows@gmk.lan"
          git config user.name "Argo Workflows"
          git add values.yaml
          git diff --cached --quiet && echo "Nothing to commit." && exit 0
          git commit -m "chore: update image.tag to ${TAG}"
          git push "https://wlanboy:${TOKEN}@github.com/wlanboy/randomfail.git"
        volumeMounts:
          - name: github-token
            mountPath: /var/run/secrets/github
      volumes:
        - name: github-token
          secret:
            secretName: github-token
            items:
              - key: token
                path: token
